<!DOCTYPE html>
<html>
  <head>
    <title>Graph</title>
    <link rel="stylesheet" href="fonts/stylesheet.css" />
    <link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <div class="wrapper">
      <div class="node start-node" id="startNode">
        <div class="node-body"><div class="content">Початок</div></div>
      </div>
      <div id="graph"></div>
    </div>

    <script src="leader-line.min.js"></script>
    <script>
      async function makeRequest(id) {
        // let response = await fetch(`http://207.180.192.253/api/Posts/${id}`);
        let response = await fetch(`http://localhost:3000/nodes`);

        if (response.ok) {
          let json = await response.json();
          console.log(json);
          return json;
        } else {
          console.error("Ошибка HTTP: " + response.status);
          return null;
        }
      }

      function getLocation(location) {
        switch (location) {
          case 0:
            return "down";
          case 2:
            return "right";
          case 3:
            return "top";
          default:
            return null;
        }
      }

      function getColor(postType) {
        switch (postType) {
          case 0:
            return "#A6A6A6";
          case 1:
            return "#3258F7";
          case 2:
            return "#FF66C4";
          default:
            return "#A6A6A6";
        }
      }

      // const nodes = [
      //   { id: 1, parent: null, location: null },
      //   { id: 2, parent: 1, location: 'right' },
      //   { id: 3, parent: 2, location: 'down' },
      //   { id: 4, parent: 3, location: 'right' },
      //   { id: 5, parent: 3, location: 'down' },
      // ];

      const nodes = [];
      let linkcs = [];
      let data = null;

      (async () => {
        data = await makeRequest(1);
        const ctorage = JSON.parse(localStorage.getItem("nodes"));

        data.forEach((item) => {
          let node = {};

          node.id = item.id;
          node.parent = item.parentPostId;
          node.location = getLocation(item.positiion);
          node.title = item.title;
          node.description = item.description;
          node.postType = item.postType;

          if (ctorage) {
            const newNode = ctorage.find((elem) => elem.id === node.id);
            if (!newNode) {
              node.newNode = true;
            }
          }

          nodes.push(node);
        });
        //------------------------//
        const nodeMap = nodes.reduce((acc, node) => {
          acc[node.id] = node;
          node.children = [];
          return acc;
        }, {});

        nodes.forEach((node) => {
          if (node.parent) {
            nodeMap[node.parent].children.push(node);
          }
        });

        const nodeSize = 200;
        const nodeSpacing = 400;
        const graph = document.getElementById("graph");

        function drawNode(x, y, node) {
          let div = document.createElement("div");
          div.className = "node";
          div.id = `nodeId${node.id}`;
          div.style.left = x - nodeSize / 2 + "px";
          div.style.top = y - nodeSize / 2 + "px";
          if (node.newNode) {
            div.classList.add("animate");
            node.newNode = false;
          }

          div.innerHTML = `
          <div class="node-body">
          <div class="title">${node.title}</div>
          <div class="content">${node.description}</div>
          </div>
          `;
          graph.appendChild(div);

          const childrenLocations = {
            down: { dx: 0, dy: 1 },
            right: { dx: 1, dy: 0 },
            top: { dx: 0, dy: -1 },
            left: { dx: -1, dy: 0 },
          };

          const childrenRight = node.children.filter(
            (child) => child.location === "right"
          );
          const isRadialLayout = childrenRight.length > 1;

          // Calculate the angle between each right child node
          const angleStep = Math.PI / (childrenRight.length + 2);
          let angleOffset = -Math.PI / 6;
          let count = 0;

          node.children.forEach((child) => {
            if (isRadialLayout && child.location === "right") {
              const offset = count > 0 ? 1.5 : 2;
              const childX = x + Math.cos(angleOffset) * (nodeSpacing * offset);
              const childY = y + Math.sin(angleOffset) * nodeSpacing;
              drawNode(childX, childY, child);

              // Increment the angle for the next child
              angleOffset += angleStep;
              count += 1;
            } else {
              const location = childrenLocations[child.location] || {
                dx: 0,
                dy: 0,
              };

              let childX = x + location.dx * nodeSpacing;
              let childY = y + location.dy * nodeSpacing;

              drawNode(childX, childY, child);
            }
          });
        }

        const rootNode = nodes.find((node) => node.parent === null);
        drawNode(300, 400, rootNode);

        console.log(nodes);
        nodes.forEach((elem) => {
          if (elem.parent !== null) {
            const start = document.querySelector(`#nodeId${elem.parent}`);
            const end = document.querySelector(`#nodeId${elem.id}`);
            if (start && end) {
              new LeaderLine(start, end, {
                color: "white",
                size: 4,
                endPlug: "arrow1",
              });
            }
          }
        });

        if (rootNode) {
          new LeaderLine(
            document.getElementById("startNode"),
            document.getElementById(`nodeId${rootNode.id}`),
            {
              color: "white",
              size: 4,
              endPlug: "arrow1",
            }
          );
        }

        localStorage.setItem("nodes", JSON.stringify(nodes));
      })();
    </script>
  </body>
</html>
